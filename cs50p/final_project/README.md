# Conversion Origin Analysis
#### Video Demo:  <https://youtu.be/OF9BUUNS4dk>
## Description:
**Conversion Origin Analysis** has the objective to load, clean and display some marketing origin results extracted from a CSV file exported from the _RD Station Marketing - Light_ marketing platform. It was created based in the necessity to get some answers that validates if a marketing campaign is actually achieving the expected results based on leads origin and the quantity of generated leads.
The results will be generated in seconds instead of many minutes if making manually and are shown as bellow:

```
Conversion Origin                # leads   % conv
-------------------------------  --------  --------
Busca paga | google              11        35.48%
Social | linkedin                10        32.26%
Tráfego direto                   8         25.81%
Social | instagram               2         6.45%
-------------------------------  --------  --------
4 origins                        31 leads  100.00%

Date     # conversions   % conv
-------  --------------  --------
2022-10  5               16.13%
2022-11  26              83.87%
-------  --------------  --------
         31 conversions  100.00%
```

The first table displays all leads origins based on the last conversion registered on RD Station Marketing; the next column is the number of conversions that each channel received, followed by the percentage it represents compared to the total amount of leads considered. They are grouped according to the volume of leads generated by each origin, the biggest value comes first. The last line represents the total of origins and total number of leads generated in this campaign.

The second table represents the number of conversions and its percentage represented by each month. They are grouped by date and the oldest date comes first to follow a chronological order.

Python libraries used:
```
- sys
- re
- csv
- hide_emails (it comes with the project and it's explained later)
- tabulate (pip instalable library - please install before running the code)
```

## Usage
To use the function you'll execute in your terminal: project.py followed by one mandatory argument that contains the RD Station Marketing .csv file's name (Don't forget the file extension), this file is a .csv containing all leads from RD database and must have at least all "necessary columns". These necessary arguments are (in portuguese): ['Tags', 'Estágio no funil', 'Data da última conversão', 'Email', 'Origem da última conversão']. Translation: Tags, Funnel's stage, Date from last conversion, Email, Last conversion origin. An arbitrary string containing a list of dates to be considered as range in the analysis. This second argument should be written as this pattern "[yyyy-mm, yyyy-mm]" or "yyyy-mm, yyyy-mm". If empty, the standard range used is all fresh leads, which are leads with no "client" status neither "tags" marked on them.

> Example 1: python project.py rd-leads-export.csv
> The results will be printed in the terminal containing all fresh leads.

> Example 2: python project.py rd-leads-export.csv "2022-09, 2022-10"
> The results will be printed in the terminal and it contains only semptember and October, 2022 results.

It's important having the tabulate library to correctly execute the tables and your RD file must NOT be named as "rd-leads.csv", because the function "hide_emails.py" will generate a file with this name.

## Functions
#### main():
The main function starts executing the code. First it will execute "validate_month" function to get the date range. Then, will call "validate_file" function, followed by the "load_leads" and lastly the "info" function. The main function also carries the list called "necessary columns" which contains all necessary columns that your csv file must have; and the valid_months which is a list of dates that filter the data (default: [] == all dates). You may have other data in your exported file, but this application  will use only the "necessary columns". These necessary arguments are (in portuguese): ['Tags', 'Estágio no funil', 'Data da última conversão', 'Email', 'Origem da última conversão']. Translation: Tags, Funnel's stage, Date from last conversion, Email, Last conversion origin.

#### validate_month():
This function will check if there is a argument after the csv path representing the dates to be used as filter to the analysis and return its value. It's expected a atring as a list containing "yyyy-mm, yyyy-mm".
If this argument is empty, the function will return [] which will show accepted leads from all date range.
If another kind of argument is given, the output in the display will be empty and also the results.

#### validate_file(sys_arguments, necessaryColumns):
The validate file will start with two arguments, the file's path/name read through the argument written in the commandline (type: string) and the variable necessaryColumns (type: list). Some validations are made to ensure the correct execution as follows:
- sys argument: validates if there is maximum of two arguments after the project.py and if this argument is a csv file; If not, it exits the program showing a message explaining why it closes.
- Existing file: try opens the file to check if this csv file is in the informed path. If not, it also closes do program with a error message.
- Checking necessary columns: it checks only the first row of the csv file looking for the necessary columns. If missing any, it exits the program and shows which column is missing. This error is showns one error per time, so if missing two or more columns, the program will show you the error different times till you finally have all columns in the file.

Finally, the function returns a string, from sys command, containing the path of the file.


#### load_leads(file_, valid_months):
The load_leads function will receive the path of the csv file as a string and valid_months brought from the variable contained in main function, which expects a list of valid months to be shown in the table's result and the expected format is "yyyy-mm".
The function will call another function, called hide_emails, which will change all the leads emails to "hidden_email@(domain path)", this will comply with leads privacy and was necessary to share the environment to others. A new file called "rd-leads.csv" will be generated in the same folder as "project.py" containing only the necessary data in the csv file and will return the name of this new file as a string to continue the load_leads function.

Load_leads will then read each line of the file and checks if the 'Tags' are empty, which means they are fresh leads, and if 'Estágio no funil' (funnel's stage) is different from 'cliente' (customer/ client). This will separate customers and old leads from the actual campaign. If it's a fresh lead, it will than format the "last conversion date", which comes usually with this format: 2022-11-29 03:42:02 -0300 to this one: 2022-11-29. It will check the valid month and appends as a dict in a list. As leads origin may comes with different writting for the same origin, so the capitalize and strip methods are used to create a pattern.

It finally returns this list, containing all accepted leads, in the dictionary format.

#### cleaning_date(date):
The function uses regex to find and change date's format. The date usually comes with this format as a string: 2022-11-29 03:42:02 -0300 from the software and is changed to another string with this format: 2022-11-29, returning as a new format.

#### get_origins(leads_dicts):
The function receives a list of dicts containing all the considered leads, reads all the origins and return a list containing all types of origins.

#### get_dates(leads_dicts):
The function receives a list of dicts containing all the considered leads, reads all dates and return a list containing all considered dates.

#### info(leads):
Info function receives the list containing all considered leads and its information as dictionaries, then will compare these leads to the return of get_origins. It will count how many leads we have for each origin and generate a dictionary list containg origin, quantity and percentage. This list is sorted by origins quantity and will print the results in the terminal window using tabulate.

Then, the function will use leads list and get_dates to count how many leads we have for each date and generates a dictionary list containg date, quantity and percentage. This list is sorted by dates in a chronological order and will print the results in the terminal window using tabulate.